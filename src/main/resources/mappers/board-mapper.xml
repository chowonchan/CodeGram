<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.kh.cgram.board.mapper.BoardMapper">


  <resultMap type="Board" id="board_rm">
  	<id property="boardNo" column="BOARD_NO"/>

	<collection 
		property="imageList"
		select="selectImageList"
		column="BOARD_NO"
		javaType="java.util.ArrayList"
		ofType="BoardImg"
	/>
  </resultMap>



	<!-- 최신 게시물 가져오기 -->
	<select id="findLatestBoards" resultType="Board">
		SELECT *
		FROM BOARD
		ORDER BY CREATED_AT DESC
		LIMIT #{pageSize} OFFSET #{pageSize} * (#{page} - 1)
	</select>

	<!-- lastBoardNo 이후 게시물 가져오기 -->
	<select id="findBoardsAfter" resultType="Board">
		SELECT *
		FROM  BOARD
		WHERE BOARD_NO > #{lastBoardNo}
		ORDER BY CREATED_AT DESC
		LIMIT #{pageSize} OFFSET #{pageSize} * (#{page} - 1)
	</select>
	
	<!-- 팔로우하지 않은 회원들의 게시물을 최신순으로 랜덤 조회 -->
	<select id="selectRandomPosts" resultType="BoardImg">
        SELECT 
            BI.BOARD_NO,
            BI.IMG_NO, 
            BI.IMG_PATH,
            BI.IMG_RENAME
        FROM 
        	BOARD B
        JOIN BOARD_IMG BI ON B.BOARD_NO = BI.BOARD_NO
        WHERE 
        	B.MEMBER_NO NOT IN (
	            SELECT FOLLOWER_MEMBER
	            FROM FOLLOW
	            WHERE FOLLOWING_MEMBER = #{memberNo}
        )
        AND B.BOARD_DEL_FL = 'N'
        AND B.MEMBER_NO != #{memberNo}
        AND IMG_ORDER = 1
        ORDER BY B.CREATED_AT DESC
    </select>
    
  <!-- 특정 게시글의 이미지를 order 순서로 조회 -->
  <select id="selectImageList" resultType="BoardImg">
  	SELECT * 
  	FROM BOARD_IMG
  	WHERE BOARD_NO = #{boardNo}
  	ORDER BY IMG_ORDER ASC
  </select>
</mapper>