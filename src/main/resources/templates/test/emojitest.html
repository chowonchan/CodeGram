<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <!-- ê¸€ ì‘ì„±ë¶€ë¶„ -->
  <div style="padding: 0px 16px;">
    <div contenteditable="true" style="width: 100%; height: 400px; padding: 0px; resize: none; border: none; outline: none;" id="emojiTextArea" spellcheck="false" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
  </div>
  <div style="width: 319px; height: 34px; display: flex; justify-content: space-between; padding: 5px; align-items: center;">
    <div style="cursor: pointer;" id="trigger">ğŸ™‚</div>
    <p style="padding: 5px"><span id="byteCount">0</span>/2000</p>
  </div>

<script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<script src="https://unpkg.com/@picmo/popup-picker@latest/dist/umd/index.js"></script>
<script>
  // ê¸€ì“°ê¸° ë¶€ë¶„
  const {createPopup: createPopupChat} = window.picmoPopup;
  const MAX_BYTES = 2000; // ìµœëŒ€ ë°”ì´íŠ¸ ì œí•œ
  const textArea = document.getElementById('emojiTextArea');
  const insertEmoji = document.getElementById('byteCount');
  let lastCaretPosition = null; // ë§ˆì§€ë§‰ ì»¤ì„œ ìœ„ì¹˜

  document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.querySelector('#trigger');

    const picker = createPopupChat({}, {
      referenceElement: trigger,
      triggerElement: trigger,
      position: 'right-end',
      zIndex: 1
    });

    trigger.addEventListener('click', () => {
      picker.toggle();
    });

    picker.addEventListener('emoji:select', (selection) => {
      // ì´ëª¨ì§€ ì‚½ì…
      const emoji = selection.emoji;

      // ë°”ì´íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      insertEmoji.textContent = textArea.innerText + emoji
      
      // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
      if (lastCaretPosition) {
        insertAtCaret(emoji);
      } else {
        // ì»¤ì„œ ìœ„ì¹˜ê°€ ì—†ë‹¤ë©´ ê·¸ëƒ¥ ë§ˆì§€ë§‰ì— ì¶”ê°€
        textArea.innerText += emoji;
      }
      
      // í…ìŠ¤íŠ¸ ì˜ì—­ì— í¬ì»¤ìŠ¤
      textArea.focus();
    });

    // ì»¤ì„œ ìœ„ì¹˜ ì¶”ì 
    textArea.addEventListener('focus', () => {
      setTimeout(() => {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          lastCaretPosition = selection.getRangeAt(0);
        }
      }, 0);
    });
  });

  // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
  function insertAtCaret(emoji) {
    if (!lastCaretPosition) return;

    const range = lastCaretPosition;
    range.deleteContents(); // í˜„ì¬ ì„ íƒëœ í…ìŠ¤íŠ¸ ì‚­ì œ

    // ìƒˆë¡œìš´ í…ìŠ¤íŠ¸ ë…¸ë“œ (ì´ëª¨ì§€)ë¥¼ ìƒì„±
    const textNode = document.createTextNode(emoji);
    range.insertNode(textNode);

    // ì‚½ì…ëœ ì´ëª¨ì§€ ë’¤ë¡œ ì»¤ì„œë¥¼ ì´ë™
    const newRange = document.createRange();
    newRange.setStartAfter(textNode);
    newRange.setEndAfter(textNode);

    // ìƒˆë¡œ ìƒì„±ëœ rangeë¥¼ ì„ íƒ ì˜ì—­ìœ¼ë¡œ ì„¤ì •
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(newRange);
    
    // ë§ˆì§€ë§‰ ì»¤ì„œ ìœ„ì¹˜ ê°±ì‹ 
    lastCaretPosition = newRange;
  }
</script>
</body>
</html>
