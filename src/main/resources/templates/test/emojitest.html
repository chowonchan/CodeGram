<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <!-- ê¸€ ì‘ì„±ë¶€ë¶„ -->
  <div style="padding: 0px 16px;">
    <div contenteditable="true" style="width: 100%; height: 400px; padding: 0px; resize: none; border: none; outline: none;" id="emojiTextArea" spellcheck="false" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
  </div>
  <div style="width: 319px; height: 34px; display: flex; justify-content: space-between; padding: 5px; align-items: center;">
    <div style="cursor: pointer;" id="trigger">ğŸ™‚</div>
    <p style="padding: 5px"><span id="byteCount">0</span>/2000</p>
  </div>

<script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<script src="https://unpkg.com/@picmo/popup-picker@latest/dist/umd/index.js"></script>
<script>
  // ê¸€ì“°ê¸° ë¶€ë¶„
  const {createPopup: createPopupChat} = window.picmoPopup;
  const MAX_BYTES = 2000; // ìµœëŒ€ ë°”ì´íŠ¸ ì œí•œ
  const textArea = document.getElementById('emojiTextArea');
  const insertEmoji = document.getElementById('byteCount');
  let lastCaretPosition = null; // ë§ˆì§€ë§‰ ì»¤ì„œ ìœ„ì¹˜

  document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.querySelector('#trigger');

    const picker = createPopupChat({}, {
      referenceElement: trigger,
      triggerElement: trigger,
      position: 'right-end',
      zIndex: 1
    });

    trigger.addEventListener('mouseover', () => {
      picker.toggle();
    });

    picker.addEventListener('emoji:select', (selection) => {
      // ì´ëª¨ì§€ ì‚½ì…
      const emoji = selection.emoji;

      // ë°”ì´íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      insertEmoji.textContent = textArea.innerText + emoji;

      // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
      if (lastCaretPosition) {
        insertTextAtCursor(emoji); // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
      } else {
        // ì»¤ì„œ ìœ„ì¹˜ê°€ ì—†ë‹¤ë©´ ê·¸ëƒ¥ ë§ˆì§€ë§‰ì— ì¶”ê°€
        textArea.innerText += emoji;
      }

      // í…ìŠ¤íŠ¸ ì˜ì—­ì— í¬ì»¤ìŠ¤
      textArea.focus();
    });

  });

  // ì»¤ì„œ ìœ„ì¹˜ì— í…ìŠ¤íŠ¸ ì‚½ì…í•˜ëŠ” í•¨ìˆ˜
  function insertTextAtCursor(emoji) {
    const selection = window.getSelection();
    
    // ì»¤ì„œ ìœ„ì¹˜ê°€ ì—†ë‹¤ë©´ ì¢…ë£Œ
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0); // ì»¤ì„œ ìœ„ì¹˜ì— í•´ë‹¹í•˜ëŠ” range ê°ì²´ ê°€ì ¸ì˜¤ê¸°

    // í…ìŠ¤íŠ¸ë¥¼ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
    range.deleteContents(); // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì˜ ê¸°ì¡´ í…ìŠ¤íŠ¸ ì‚­ì œ
    range.insertNode(document.createTextNode(emoji)); // ì´ëª¨ì§€ë¥¼ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…

    // ì‚½ì… í›„ ì»¤ì„œë¥¼ ìƒˆë¡œ ì‚½ì…í•œ í…ìŠ¤íŠ¸(ì´ëª¨ì§€)ì˜ ë’¤ë¡œ ì´ë™ì‹œí‚´
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
  }
</script>
</body>
</html>
